<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>IoT Button configuration</title>
    <link rel="shorcut icon" type="img/ico "href="/img/favicon.ico">

    <meta name="description" content="web server for IoT button configuration">
    <meta name="author" content="paclema">

    <!-- <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet"> -->

    <!-- Bootstrap 3.0 -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> -->

    <!-- Bootstrap 4.0 -->
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script> -->

    <!-- Locally stored -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- <script src="php/save_config.php"></script>
    <script src="php/restore_backup.php"></script> -->
    <!-- <script src="config.json"></script> -->


  </head>
  <body role="document" data-gr-c-s-loaded="true" style>


    <div id="shifty-spritz" style="display: none;" tabindex="1">
      <div id="words-shifty">
        <div id="countdown-shifty" style="font-size: 25px; height: 50px; line-height: 50px; font-weight: bold; font-family: "droid sans";"></div>
        <div id="left-shifty" style="font-size: 25px; height: 50px; line-height: 50px; font-weight: bold; font-family: "droid sans";"></div>
        <div id="center-shifty" style="font-size: 25px; height: 50px; line-height: 50px; font-weight: bold; font-family: "droid sans"; color: rgb(250, 61, 61);"></div>
        <div id="right-shifty" style="font-size: 25px; height: 50px; line-height: 50px; font-weight: bold; font-family: "droid sans";"></div>
        <span id="clear-shifty"></span>
      </div>
      <div id="controls-shifty">
        <i id="pause-play-shifty" class="fa fa-pause left-shifty"></i>
        <i id="close-shifty" class="fa fa-times right-shifty"></i>
        <div id="progress-bar-shifty">
          <div id="progress-shifty"></div>
          <div id="seek-shifty"></div>
        </div>
      </div>
    </div>



    <div class="container theme-showcase" role="main">
      <!-- <h1>IoT Button configuration</h1> -->
      <legend>IoT Button configuration</legend>
      <form class="form-horizontal" method="post">
        <fieldset id="form">

          <!-- This form will be generated by the script, reading the config.json file -->

        </fieldset>
      </form>




      <!-- Buttons -->
      <div class="container theme-showcase" role="main">
      <!-- <div class="row"> -->
        <div id="buttons" class="float-right" style="margin-bottom: 20px; float: right;">
        <!-- <div id="buttons" body class="panel-body"> -->
          <button type="button" id="SaveConfig" value="SaveConfig" class="btn btn-primary">Save</button>
          <button type="button" id="Restart" value="Restart" class="btn btn-success">Save & restart</button>

          <button type="button" id="LoadConfig" value="LoadConfig" class="btn btn-warning">Load configs</button>
          <button type="button" id="Factory" value="Factory" class="btn btn-danger">Factory defaults</button>
          <!-- <button type="button" id="gpio_test" value="gpio_test" class="btn btn-outline-info">GPIO test</button> -->
          <button type="button" id="gpio_test" value="gpio_test" class="btn btn-info" style="margin-left:50px">GPIO LED test</button>
        </div>
      </div>


      <!-- <form>
        <div class="form-group">
          <label for="exampleFormControlFile1">Example file input</label>
          <input type="file" class="form-control-file" id="exampleFormControlFile1">
        </div>
      </form> -->

      <!-- <div class="custom-file">
        <input type="file" class="custom-file-input" id="customFile">
        <label class="custom-file-label" for="customFile">Choose file</label>
      </div> -->





      <!-- <div class="row" style="position:relative-right; bottom:0; width:100%">
       <div class="col-xs-2 col-md-2"><img src="img/logo.png" width="30" height="30"></div>
       <div class="stretched-link float-right">
         <p><a href="http://www.github.com/paclema/iot_button" class="stretched-link float-right">github.com/paclema/iot_button</a></p>
       </div>
     </div> -->

     <div class="container-fluid">
        <div class="row">
        </div>
     </div>

    </div>
  </body>




  <script>

    var config;

    $(loadConfig(config));



    // Button functions:

    $('#gpio_test').click(function(){
       setGPIO('LED_BUILTIN',true);
     });


    document.getElementById("SaveConfig").onclick = function SaveConfig() {
      //submitForms(config);
      console.log("SaveConfig");
      //console.log(config);

      var config_reloaded = formToConfig(config);

      storeJson(config_reloaded);
      //console.log(config_reloaded);
    };
    document.getElementById("Restart").onclick = function Restart() {
      console.log("Restart");
      var config_reloaded = formToConfig(config);
      console.log(config_reloaded);
      storeJson(config_reloaded);

      //Restart esp8266
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/restart", true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");


      // xhr.send('key1=value1&key2=value2');
      // Can be read from firmware as:
      // String val1 = server.arg("key1");
      // String val2 = server.arg("key2");

      xhr.send("restart=true");
      xhr.onreadystatechange = (e) => {
        console.log(xhr.responseText);
        window.location.reload();
      }


    };
    document.getElementById("LoadConfig").onclick = function LoadConfig() {
      console.log("LoadConfig");
      //Load config.json
      //loadConfig();
      window.location.reload();
    };
    document.getElementById("Factory").onclick = function Factory() {
      console.log("Factory");

      //Remove current config.json Move config.json.bak to config.json:
      restoreBackup();

      //Load config.json
      //loadConfig();

    };

    // // To save a file
    // // var textToSave = 'this is a test';
    // var hiddenElement = document.createElement('a');
    // hiddenElement.href = 'data:attachment/text,' + encodeURI(config);
    // hiddenElement.target = '_blank';
    // hiddenElement.download = 'myFile.txt';
    // hiddenElement.click();



    function loadConfig(data) {
       //var config = [];
       $.getJSON('config.json', function(data) {

         // window.config is the global object config
         window.config = data;
         //   $.each(data.person, function(i, f) {
         //      var tblRow = "<tr>" + "<td>" + f.firstName + "</td>" +
         //       "<td>" + f.lastName + "</td>" + "<td>" + f.job + "</td>" + "<td>" + f.roll + "</td>" + "</tr>"
         //       $(tblRow).appendTo("#userdata tbody");
         // });


         //config = config[0];
         console.log(window.config);
         // console.log(config["network"]);
         // console.log(config.network);
         // console.log(config.mqtt.server);

         var id_name
         var form= document.getElementById("form");
         for (var tab in window.config){

           id_name = tab;
           form.innerHTML += "<div id=\"" + id_name + "\" class=\"panel panel-default\">"
           var formpanel = document.getElementById(id_name);

           id_name = id_name + "_body";
           formpanel.innerHTML += "<div class=\"panel-heading\">"+ tab.charAt(0).toUpperCase() + tab.slice(1) +"</div>"
           formpanel.innerHTML += "<div id=\"" + id_name + "\" class=\"panel-body\">"

           var formbody= document.getElementById(id_name);
           for(var key in window.config[tab]){

             id_name = tab + "_" + key + "_form";
             formbody.innerHTML += "<div id=\"" + id_name + "\" class=\"form-group\">"
             var formobjs= document.getElementById(id_name);

             var key_name = key.charAt(0).toUpperCase() + key.slice(1)
             formobjs.innerHTML += "<label class=\"col-md-4 control-label\" for=\""+key+"\">" + key_name.replace(/_/g, ' '); + "</label>"

             id_name = tab + "_" + key + "_input";
             formobjs.innerHTML += "<div id=\"" + id_name + "\" class=\"col-md-4\">"
             var formimput= document.getElementById(id_name);


             //Filter here the type of value
             var val = window.config[tab][key];

             // Boolean configurations:
            if (typeof val === 'boolean' || val == "true" || val == "false") {
              formimput.innerHTML +="<label class=\"checkbox-inline\"><input type=\"hidden\" value name=\""+key+"\">"
              //console.log(key + ":" + val);
              // To prevent bolean quoted:
              var isTrueSet  = (val === 'true' || val === true);
              //console.log("isTrueSet:" + isTrueSet);
              if (isTrueSet === true){formimput.innerHTML += "<input id=\""+key+"\"name=\""+key+"\" type=\"checkbox\" value=\""+val+"\" class=\"input-md\" checked=\"checked\">"}
              else {formimput.innerHTML += "<input id=\""+key+"\"name=\""+key+"\" type=\"checkbox\" value=\""+val+"\" class=\"input-md\" >"}
              formimput.innerHTML +="</label>"
            }

            // "Info" specific secction (only show non editable form):
            else if (tab === "info") {
              formimput.innerHTML += "<input readonly id=\""+key+"\" name=\""+key+"\" type=\"text\" placeholder=\"-\" class=\"form-control input-md\" value=" + val + ">"
              // formimput.innerHTML += "<input readonly id=\""+key+"\" name=\""+key+"\" type=\"text\" placeholder=\"\" class=\"form-control-plaintext\" value=" + val + ">"
            }

            // The rest input forms are text type:
            else {

              // If the object its a password, we hide the value:
              if (key.includes("password")){
                formimput.innerHTML += "<input id=\""+key+"\" name=\""+key+"\" type=\"password\" placeholder=\"Password\" class=\"form-control input-md\" value=" + val + ">"
                // formimput.innerHTML += "<div class=\"invalid-tooltip\">Please choose a unique and valid username.</div>"
              }

              // If the object contains a file path, we include a file input:
              else if (key.includes("file")){
                formimput.innerHTML += "<input id=\""+key+"\" name=\""+key+"\" type=\"text\" placeholder=\""+key+"\" class=\"form-control input-md\" value=" + val + ">"

                // formimput.innerHTML += `<div class="custom-file">
                //                          <input type="file" class="custom-file-input" id="customFile">
                //                          <label class="custom-file-label" for="customFile">Choose file</label>
                //                        </div>`



                // formimput.innerHTML += `<form class="md-form">
                //             <div class="file-field">
                //               <div class="btn btn-primary btn-sm float-left">
                //                 <span>Choose file</span>
                //                 <input type="file">
                //               </div>
                //               <div class="file-path-wrapper">
                //                 <input class="file-path validate" type="text" placeholder="Upload your file">
                //               </div>
                //             </div>
                //           </form>`
              }

              // The rest objects:
              else {
                formimput.innerHTML += "<input id=\""+key+"\" name=\""+key+"\" type=\"text\" placeholder=\""+key+"\" class=\"form-control input-md\" value=" + val + ">"
              }

            }

             formobjs.innerHTML +="</div>"
             formbody.innerHTML +="</div>"
            }

           formpanel.innerHTML +="</div>"
           formpanel.innerHTML +="</div>"
           form.innerHTML +="</div>"




         }


         // form.innerHTML += `<div class="row" style="position:relative; bottom:0; width:100%">
         //  <!-- <div class="col-xs-2 col-md-2"><img src="img/logo.png" width="30" height="30"></div> -->
         //  <div class="col-xs-5 col-md-5">
         //    <p><a href="http://www.projetsdiy.fr">Version francaise : www.projetsdiy.fr</a></p>
         //  </div>
         //  <div class="col-xs-5 col-md-5">
         //    <p><a href="http://www.diyprojects.io">English version : www.diyprojects.io</a></p>
         //  </div>
         // </div>`


       });
    };

    function restoreBackup(){
      // $.ajax({
      //     type: "GET",
      //     dataType : 'json',
      //     async: false,
      //     url: '/php/restore_backup.php',
      //     //data: { data: JSON.stringify(config) },
      //     data: {},
      //     success: function () {alert("Thanks!"); },
      //     failure: function() {alert("Error!");}
      // });

      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/restore_config", true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");


      // xhr.send('key1=value1&key2=value2');
      // Can be read from firmware as:
      // String val1 = server.arg("key1");
      // String val2 = server.arg("key2");

      xhr.send("filename=config.json");
      xhr.onreadystatechange = (e) => {
        console.log(xhr.responseText);
        window.location.reload();
      }




    };

    function storeJson(config){
      console.log("Storing the data...");
      console.log(config);

      // Using php file:
      // $.ajax({
      //     type: "GET",
      //     dataType : 'json',
      //     url: '/php/save_config.php',
      //     async: true,
      //     data: { data: JSON.stringify(config) },
      //     //data: `{ "data": JSON.stringify(window.config) }`,
      //     success: function () {alert("Thanks!"); },
      //     failure: function() {alert("Error!");}
      // });

      // Direclty using POST req configured in the fw:
      var xhr = new XMLHttpRequest();
      xhr.open("POST", "/save_config", true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
      xhr.send(JSON.stringify(window.config));
      console.log("data stored");

    };


    function formToConfig(config){
      var config_reloaded = config;

      var formpanel;
      var formval;
      for (var tab in config){
        //search forms for each tab form:
        formpanel=document.getElementById(tab);
        for (var key in config[tab]){
          formval=document.getElementById(key);
          var val = formval.value;
          // If the value is true or false, we need to check the checked value:
          if (typeof val === 'boolean' || val == "true" || val == "false") {
            val = formval.checked;
          }
          config_reloaded[tab][key]= val;
        }

      }
      console.log("config reloaded");
      return config_reloaded;
    };


    function setGPIO(id, val) {

      $.post("gpio?id=" + id + "&val=" + val).done(function(data){
        console.log("Returned POST req: " + JSON.stringify(data));

        // Data returned: data

        var id_gpio = "#" + id + "_val";
        //console.log(id_gpio);
        // if ( data.success === "1" ) {
        //   if ( data.val === "1" ) {
        //     $(id_gpio).html("ON");
        //   } else {
        //     $(id_gpio).html("OFF");
        //   }
        // } else {
        //   $(id_gpio).html('!');
        // }
      }).fail(function(err){
        console.log("Error POST REQ: " + JSON.stringify(err));
      });

    }



  </script>
</html>
